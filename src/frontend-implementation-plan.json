{
  "kind": "implementation_plan",
  "version": "1.0",
  "title": "Resolve production black screen on load (Version 47)",
  "requirements": [
    {
      "id": "REQ-5",
      "summary": "Ensure the app reliably mounts and renders an initial UI in production, and never remains a blank black screen (including providing a pre-mount crash fallback).",
      "acceptanceCriteria": [
        "Loading the deployed app shows the normal UI (Hero / initialization screen) instead of a blank black screen.",
        "The browser console no longer shows a fatal startup exception that prevents React from mounting.",
        "If an unexpected runtime error occurs, the app displays an error fallback UI (not a blank screen)."
      ],
      "file_operations": [
        {
          "path": "frontend/index.html",
          "operation": "modify",
          "description": "Add a lightweight pre-React startup guard: (1) ensure #root has a minimal initial loading UI to avoid a blank screen while the JS bundle loads; (2) register window-level error and unhandledrejection handlers that replace #root with a basic English error fallback message if a fatal error happens before React mounts."
        },
        {
          "path": "frontend/src/App.tsx",
          "operation": "modify",
          "description": "Harden startup rendering paths to avoid blank output: keep the existing ErrorBoundary and initialization screen, and ensure any error-detail gating uses Vite-compatible environment checks (so the ErrorFallback itself cannot throw)."
        }
      ]
    },
    {
      "id": "REQ-6",
      "summary": "Add a safe `process.env` polyfill that executes before the React bundle to prevent `process is not defined` crashes (without modifying immutable hook files).",
      "acceptanceCriteria": [
        "On a fresh page load, the app does not throw `ReferenceError: process is not defined`.",
        "`process.env.II_URL` is defined at runtime (via the polyfill) so Internet Identity login can initialize without crashing.",
        "`process.env.NODE_ENV` is defined at runtime (via the polyfill) so environment checks do not crash the app."
      ],
      "file_operations": [
        {
          "path": "frontend/index.html",
          "operation": "modify",
          "description": "Insert an inline script in <head> (before the module script tag that loads /src/main.tsx) that defines globalThis.process if missing and ensures process.env exists with at least II_URL and NODE_ENV populated (using safe defaults and non-destructive assignment so it wonâ€™t override if already defined)."
        }
      ]
    },
    {
      "id": "REQ-7",
      "summary": "Remove remaining editable frontend usages of `process.env.NODE_ENV` by switching to Vite-compatible environment checks.",
      "acceptanceCriteria": [
        "The frontend codebase no longer relies on `process.env.NODE_ENV` in editable files (e.g., App.tsx).",
        "The app builds and runs in production without requiring Node-style `process` globals beyond the REQ-6 polyfill (which exists to support immutable hook code)."
      ],
      "file_operations": [
        {
          "path": "frontend/src/App.tsx",
          "operation": "modify",
          "description": "Replace `process.env.NODE_ENV === 'development'` checks with Vite-compatible checks (e.g., import.meta.env.DEV / import.meta.env.MODE) so editable code no longer depends on Node-style process globals."
        }
      ]
    }
  ]
}